<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
</head>

<body>
  
</body>

</html>
<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>الاختبار النهائي — تفاعلي</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-1: #2b1f4d;
    --bg-2: #5b3ea6;
    --glass-bg: rgba(255,255,255,0.05);
    --glass-border: rgba(255,255,255,0.12);
    --accent: #ffffff;
    --glass-radius: 20px;
    --card-w: min(980px,94vw);
    --card-h: min(780px,92vh);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Tajawal',sans-serif;direction:rtl;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));display:flex;align-items:center;justify-content:center;color:var(--accent)}
  .stage{width:100%;height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
  .glass{
    width:var(--card-w);
    height:var(--card-h);
    border-radius:var(--glass-radius);
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.08);
    box-shadow: 0 20px 50px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
    padding:18px;display:flex;flex-direction:column;position:relative;overflow:hidden;
    backdrop-filter: blur(10px) saturate(120%);
  }
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .title{font-size:20px;font-weight:800}
  .timer{font-size:16px}
  .viewer{flex:1;border-radius:14px;background:transparent;position:relative;overflow:auto;padding:12px}
  .controls{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:12px}
  button.primary{background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.08);padding:12px 18px;border-radius:12px;color:var(--accent);cursor:pointer;font-weight:700}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 14px;border-radius:10px;color:var(--accent);cursor:pointer}
  .page{display:none;padding:18px;height:100%;box-sizing:border-box}
  .page.active{display:block}
  .center-box{max-width:880px;margin:0 auto}
  label.small{display:block;color:rgba(255,255,255,0.8);margin-bottom:6px;font-weight:600}
  input[type="text"], input[type="password"], textarea, select{
    width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--accent);outline:none;font-size:15px;box-shadow: inset 0 2px 8px rgba(0,0,0,0.2);
  }
  textarea{min-height:120px;resize:vertical}
  .row{display:flex;gap:12px;align-items:center}
  .muted{color:rgba(255,255,255,0.7);font-size:13px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.04);margin-bottom:12px}
  /* MCQ styles */
  .mcq-question{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);margin-bottom:10px;background:rgba(0,0,0,0.02)}
  .opt{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;margin-top:8px;background:rgba(255,255,255,0.01)}
  .opt.selected{outline:2px solid rgba(0,200,120,0.25);box-shadow:0 6px 18px rgba(0,0,0,0.35)}
  /* result big number */
  .result-big{font-size:64px;font-weight:900}
  .celebrate{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;z-index:1}
  /* modals (glass) */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal-card{width:min(520px,92%);background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border-radius:16px;padding:18px;border:1px solid rgba(255,255,255,0.08);box-shadow:0 12px 40px rgba(0,0,0,0.7)}
  /* green circular check */
  .check-circle{width:84px;height:84px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#2bbf8a,#12a07a);box-shadow:0 6px 18px rgba(14,86,65,0.25);border:6px solid rgba(255,255,255,0.06);transform:translateY(0)}
  .check-icon{width:44px;height:44px;color:#fff;font-weight:900;display:flex;align-items:center;justify-content:center;font-size:34px}
  /* little animation for appearing message */
  .enter-notify{position:fixed;left:50%;transform:translateX(-50%);top:12vh;z-index:9998;transition:all .22s ease;opacity:0;pointer-events:none}
  .enter-notify.show{opacity:1;transform:translateX(-50%) translateY(0)}
  /* small style tweaks */
  @media (max-width:820px){ .glass{width:96vw;height:92vh;padding:12px} .result-big{font-size:44px} .check-circle{width:64px;height:64px} }
</style>
</head>
<body>
<div class="stage">
  <div class="glass" role="application" aria-label="الاختبار النهائي">
    <div class="topbar">
      <div class="title">الاختبار النهائي</div>
      <div class="timer" id="timerDisplay">الوقت: 12:00</div>
    </div>

    <div class="viewer" id="viewer">
      <!-- صفحة 1: البداية -->
      <section id="page-1" class="page active">
        <div class="center-box">
          <h2 style="font-weight:800;margin-bottom:8px">مرحبا — املأ بياناتك لبدء الاختبار</h2>
          <div class="card">
            <label class="small">الاسم الكامل</label>
            <input id="studentName" type="text" placeholder="أدخل الاسم" />
            <div style="height:8px"></div>
            <label class="small">البريد الإلكتروني</label>
            <input id="studentEmail" type="text" placeholder="example@mail.com" />
            <div style="height:8px"></div>
            <label class="small">رقم الهاتف</label>
            <input id="studentPhone" type="text" placeholder="015xxxxxxxx" />
            <div style="height:8px"></div>
            <label class="small">المحافظة</label>
            <input id="studentProvince" type="text" placeholder="القاهرة" />
            <div style="height:12px"></div>
            <div style="display:flex;justify-content:flex-end">
              <button id="startBtn" class="primary">ابدأ الاختبار</button>
            </div>
            <div style="height:8px"></div>
            <div class="muted">بعد الضغط على ابدأ، سيبدأ المؤقت ولا يمكنك العودة إلى هذه الصفحة.</div>
          </div>
        </div>
      </section>

      <!-- صفحات الأكواد 2..8 (كل صفحة بنفس الاستايل) -->
      <section id="page-2" class="page">
        <div class="center-box">
          <h3>ما هو كود سيشن الأسبوع الأول؟</h3>
          <div style="height:12px"></div>
          <div class="card">
            <input id="codeP2" type="text" placeholder="اكتب الكود هنا" />
            <div style="height:12px"></div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="muted">اكتب الكود ثم اضغط التالي</div>
              <div>
                <button id="nextP2" class="primary">التالي</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="page-3" class="page">
        <div class="center-box">
          <h3>ما هو كود سيشن الأسبوع الثاني؟</h3>
          <div style="height:12px"></div>
          <div class="card">
            <input id="codeP3" type="text" placeholder="اكتب الكود هنا" />
            <div style="height:12px"></div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="muted">اكتب الكود ثم اضغط التالي</div>
              <div><button id="nextP3" class="primary">التالي</button></div>
            </div>
          </div>
        </div>
      </section>

      <section id="page-4" class="page">
        <div class="center-box">
          <h3>ما هو كود سيشن الأسبوع الثالث؟</h3>
          <div style="height:12px"></div>
          <div class="card">
            <input id="codeP4" type="text" placeholder="اكتب الكود هنا" />
            <div style="height:12px"></div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="muted">اكتب الكود ثم اضغط التالي</div>
              <div><button id="nextP4" class="primary">التالي</button></div>
            </div>
          </div>
        </div>
      </section>

      <section id="page-5" class="page">
        <div class="center-box">
          <h3>ما هو كود سيشن الأسبوع الرابع؟</h3>
          <div style="height:12px"></div>
          <div class="card">
            <input id="codeP5" type="text" placeholder="اكتب الكود هنا" />
            <div style="height:12px"></div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="muted">اكتب الكود ثم اضغط التالي</div>
              <div><button id="nextP5" class="primary">التالي</button></div>
            </div>
          </div>
        </div>
      </section>

      <section id="page-6" class="page">
        <div class="center-box">
          <h3>ما هو كود سيشن الأسبوع الخامس؟</h3>
          <div style="height:12px"></div>
          <div class="card">
            <input id="codeP6" type="text" placeholder="اكتب الكود هنا" />
            <div style="height:12px"></div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="muted">اكتب الكود ثم اضغط التالي</div>
              <div><button id="nextP6" class="primary">التالي</button></div>
            </div>
          </div>
        </div>
      </section>

      <section id="page-7" class="page">
        <div class="center-box">
          <h3>ما هو كود سيشن الأسبوع السادس؟</h3>
          <div style="height:12px"></div>
          <div class="card">
            <input id="codeP7" type="text" placeholder="اكتب الكود هنا" />
            <div style="height:12px"></div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="muted">اكتب الكود ثم اضغط التالي</div>
              <div><button id="nextP7" class="primary">التالي</button></div>
            </div>
          </div>
        </div>
      </section>

      <section id="page-8" class="page">
        <div class="center-box">
          <h3>ما هو كود سيشن الأسبوع السابع؟</h3>
          <div style="height:12px"></div>
          <div class="card">
            <input id="codeP8" type="text" placeholder="اكتب الكود هنا" />
            <div style="height:12px"></div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="muted">اكتب الكود ثم اضغط التالي</div>
              <div><button id="nextP8" class="primary">التالي</button></div>
            </div>
          </div>
        </div>
      </section>

      <!-- صفحة 9: MCQ -->
      <section id="page-9" class="page">
        <div class="center-box">
          <h3>أسئلة اختيار من متعدد</h3>
          <div class="muted">اختر إجابة لكل سؤال — إجاباتك ستُسجَّل كما اخترتها.</div>
          <div style="height:12px"></div>
          <div id="mcqList" style="max-height:520px;overflow:auto;padding-right:6px"></div>
          <div style="height:10px"></div>
          <div style="display:flex;justify-content:flex-end"><button id="nextFromMCQ" class="primary">التالي</button></div>
        </div>
      </section>

      <!-- صفحة 10: Essays (10 questions) -->
      <section id="page-10" class="page">
        <div class="center-box">
          <h3>الأسئلة المقالية</h3>
          <div class="muted">اكتب إجاباتك بصراحة — سيتم إرسالها كما كتبتها.</div>
          <div style="height:12px"></div>
          <div id="essaysContainer" style="max-height:520px;overflow:auto;padding-right:6px"></div>
          <div style="height:12px"></div>
          <div style="display:flex;justify-content:flex-end"><button id="toResult" class="primary">عرض النتيجة</button></div>
        </div>
      </section>

      <!-- صفحة 11: النتيجة -->
      <section id="page-11" class="page">
        <div class="center-box" style="position:relative;z-index:2">
          <h2 style="margin-bottom:8px">النتيجة</h2>
          <div style="height:8px"></div>
          <div style="display:flex;gap:18px;align-items:center">
            <div>
              <div class="result-big" id="scorePct">--%</div>
              <div class="muted">درجتك النهائية</div>
            </div>
            <div style="flex:1">
              <div class="muted">النظام حسب إجابات الأكواد والأسئلة الاختيارية لتحديد النتيجة.</div>
            </div>
          </div>
          <div style="height:16px"></div>
          <div style="display:flex;gap:10px;justify-content:flex-end">
            <button id="sendAnswersBtn" class="primary">إرسال الإجابات (WhatsApp)</button>
            <button id="goToExit" class="ghost">الخروج</button>
          </div>
        </div>
        <div class="celebrate" aria-hidden="true" id="celebrateEl" style="z-index:1;pointer-events:none;opacity:1">
          <!-- Simple confetti-like visual (can be left decorative) -->
          <div style="font-size:28px;font-weight:900;color:gold;text-shadow:0 2px 10px rgba(0,0,0,0.5)">🎉 مبروك! 🎉</div>
        </div>
      </section>

      <!-- صفحة 12: الخروج -->
      <section id="page-12" class="page">
        <div class="center-box">
          <div class="card">
            <h3>لقد تم الخروج من الاختبار</h3>
            <div style="height:8px"></div>
            <div class="muted">لا يسمح بالرجوع مرة أخرى إلا بكود إعادة الفتح (خاص وسري).</div>
            <div style="height:12px"></div>
            <div style="display:flex;gap:10px">
              <button id="sendAnswersBtnExit" class="primary">إرسال الإجابات (WhatsApp)</button>
              <button id="openReopenBox" class="ghost">الخروج</button>
            </div>
          </div>
        </div>
      </section>

    </div>

    <div class="controls">
      <button id="prevBtn" class="ghost">السابق</button>
      <button id="nextBtn" class="ghost">التالي</button>
      <div class="muted">صفحة <span id="pageIndex">1</span> / 12</div>
    </div>
  </div>
</div>

<!-- Enter notify (appears on page change) -->
<div id="enterNotify" class="enter-notify">
  <div class="modal-card" style="display:flex;gap:12px;align-items:center">
    <div class="check-circle"><div class="check-icon">✔</div></div>
    <div style="font-weight:700;font-size:18px" id="enterNotifyText">تم الدخول إلى الصفحة</div>
  </div>
</div>

<!-- Modal: password (for reopen after exit or time) -->
<div id="reopenModal" class="modal-overlay" style="display:none">
  <div class="modal-card">
    <div style="font-weight:800;font-size:18px;margin-bottom:8px">أدخل كلمة المرور</div>
    <div class="muted" style="margin-bottom:12px">أدخل الكود لفتح الاختبار من البداية.</div>
    <input id="reopenInput" type="password" placeholder="...أدخل الكود" />
    <div style="height:12px"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button id="reopenCancel" class="ghost">إلغاء</button>
      <button id="reopenConfirm" class="primary">فتح</button>
    </div>
  </div>
</div>

<!-- Modal: time closed -->
<div id="timeClosedModal" class="modal-overlay" style="display:none">
  <div class="modal-card">
    <div style="font-weight:800;font-size:18px;margin-bottom:8px">تم غلق الاختبار</div>
    <div class="muted" style="margin-bottom:12px">انتهى الوقت. أدخل الكود لإعادة فتح الاختبار.</div>
    <input id="timeReopenInput" type="password" placeholder="...أدخل الكود" />
    <div style="height:12px"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button id="timeModalCancel" class="ghost">إغلاق</button>
      <button id="timeModalConfirm" class="primary">فتح</button>
    </div>
  </div>
</div>

<script>
/*
  كامل: 12 صفحة، 7 صفحات أكواد، 10 MCQ، 10 essays، نتيجة، خروج.
  المؤقت 12 دقيقة. لا نكشف أكواد إعادة الفتح أو أي سرّيّة على الواجهة.
  الأكواد الصحيحة للأكواد السبعة محفوظة داخلياً (لتقييم النتيجة)،
  لكن المستخدم لا يرى أي نتيجة تصحيحية أثناء الحل.
*/

/* ========== إعداد المتغيرات الأساسية ========== */
const PAGES = 12;
let currentPage = 1;
const pageIndexEl = document.getElementById('pageIndex');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const startBtn = document.getElementById('startBtn');
const timerDisplay = document.getElementById('timerDisplay');
const enterNotify = document.getElementById('enterNotify');
const enterNotifyText = document.getElementById('enterNotifyText');

const TOTAL_SECONDS = 12 * 60;
let timerRemaining = TOTAL_SECONDS;
let timerInterval = null;

/* حالة المستخدم - سنخزن ما كتبه المستخدم (الأجوبة الفعلية) */
const answers = {
  meta: {name:'', email:'', phone:'', province:''},
  codes: {}, // page -> value entered (2..8)
  mcq: {},   // qIndex -> selected index (0..3)
  essays: {} // 1..10 -> text
};

/* مفاتيح الإجابات السرية (لا تظهر في الواجهة) — تُستخدم لحساب النتيجة */
const secretCodes = {2:'8075',3:'91053',4:'8846',5:'5907',6:'6189',7:'1637',8:'0927'};

/* إجابات الاختياري الصحيحة (index of option 0..3) */
const mcqCorrect = [1,1,1,1,2,1,1,2,2,1]; // بما يتوافق مع تسلسل الأسئلة

/* أكواد إعادة الفتح (سريّة) — لن تظهر */
const REOPEN_EXIT = '55666777788888'; // لصفحة الخروج
const REOPEN_TIME = '11222333344444'; // عند نفاد الوقت

/* منع محاولة متعددة لكل جهاز ما لم يعاد فتحه */
function markAttempted(){ localStorage.setItem('attempted','true'); }
function isAttempted(){ return localStorage.getItem('attempted') === 'true'; }

/* حفظ واسترجاع التقدّم */
function saveProgress(){
  const payload = {answers, timerRemaining, currentPage, maxVisited: localStorage.getItem('maxVisited')||1};
  localStorage.setItem('progressData', JSON.stringify(payload));
}
function loadProgress(){
  const data = localStorage.getItem('progressData');
  if(!data) return;
  try{
    const p = JSON.parse(data);
    if(p.answers) Object.assign(answers, p.answers);
    if(p.timerRemaining) timerRemaining = p.timerRemaining;
    if(p.currentPage) currentPage = p.currentPage;
  }catch(e){}
}
loadProgress();

/* ========== وظائف التنقل والصفحات ========== */
function showPage(n, showNotify=true){
  if(n<1) n=1; if(n>PAGES) n=PAGES;
  const maxVisited = Number(localStorage.getItem('maxVisited')||1);
  // عدم السماح بالرجوع لصفحات سابقة
  if(n < maxVisited){
    alert('غير مسموح بالرجوع للصفحات السابقة.');
    return;
  }
  // تفعيل الصفحة
  for(let i=1;i<=PAGES;i++){
    const el = document.getElementById('page-'+i);
    if(el) el.classList.toggle('active', i===n);
  }
  currentPage = n;
  pageIndexEl.textContent = `${currentPage}`;
  // تعطيل زر السابق لو الصفحة >1
  prevBtn.disabled = currentPage > 1;
  // سجل أعلى صفحة زارها
  if(currentPage > maxVisited) localStorage.setItem('maxVisited', String(currentPage));
  saveProgress();
  // notify (enter) عند الانتقال — يظهر ثانية واحدة
  if(showNotify){
    showEnterNotify(`تم الدخول إلى صفحة ${getPageName(currentPage)}`);
  }
  // عند الوصول لصفحة النتيجة، احسب نتيجة
  if(currentPage === 11){
    computeAndShowResult();
  }
}

/* اسم الصفحة لأغراض الإشعار */
function getPageName(n){
  if(n===1) return 'البداية';
  if(n>=2 && n<=8) return `كود الأسبوع ${n-1}`;
  if(n===9) return 'الأسئلة الاختيارية';
  if(n===10) return 'الأسئلة المقالية';
  if(n===11) return 'النتيجة';
  if(n===12) return 'الخروج';
  return '';
}

/* عرض إشعار دخول صفحة مع دائرة الصح الخضراء لثانية واحدة */
let notifyTimeout = null;
function showEnterNotify(text){
  enterNotifyText.textContent = text;
  enterNotify.classList.add('show');
  clearTimeout(notifyTimeout);
  notifyTimeout = setTimeout(()=> enterNotify.classList.remove('show'), 1000);
}

/* زر السابق والالتالي العام */
prevBtn.addEventListener('click', ()=> showPage(currentPage-1));
nextBtn.addEventListener('click', ()=> {
  if(currentPage < PAGES) showPage(currentPage+1);
});

/* ========== START: بدء الاختبار ========== */
startBtn.addEventListener('click', ()=>{
  if(isAttempted()){
    alert('هذا الجهاز استُخدم للاختبار من قبل. إذا لديك كود إعادة الفتح استخدمه من صفحة الخروج.');
    return;
  }
  // read meta
  answers.meta.name = document.getElementById('studentName').value.trim() || 'غير مُدرج';
  answers.meta.email = document.getElementById('studentEmail').value.trim() || 'غير مُدرج';
  answers.meta.phone = document.getElementById('studentPhone').value.trim() || 'غير مُدرج';
  answers.meta.province = document.getElementById('studentProvince').value.trim() || 'غير مُدرج';
  markAttempted();
  // go to page 2 and start timer
  showPage(2);
  startTimer();
});

/* ========== صفحات الأكواد: تسجيل ما كتبه المستخدم والانتقال ========== */
for(let p=2;p<=8;p++){
  const btn = document.getElementById('nextP'+p);
  if(btn){
    btn.addEventListener('click', ()=>{
      const val = (document.getElementById('codeP'+p).value || '').trim();
      answers.codes[p] = val || 'لم يُدخل';
      saveProgress();
      // goto next
      showPage(p+1);
    });
  }
}

/* ========== MCQ: بناء الأسئلة وقراءة الاختيارات ========== */
const mcqQuestions = [
  {q:"أول خطوة في رحلة تطوير الذات هي:", opts:["مقارنة نفسك بالآخرين","معرفة نقاط قوتك وضعفك","التركيز على العيوب","تجاهل المشاعر"]},
  {q:"التفكير الإيجابي يعني:", opts:["إنكار الواقع","النظر للمشكلة من زاوية الحل","تجاهل الصعوبات","الاعتماد على الحظ"]},
  {q:"من علامات الذكاء العاطفي:", opts:["كبت المشاعر","فهم مشاعر نفسك والآخرين","تجنّب التفاعل مع الناس","الانفعال السريع"]},
  {q:"أفضل طريقة لتنظيم الوقت:", opts:["العمل العشوائي","كتابة المهام اليومية وتحديد الأولويات","تأجيل المهام الصعبة","العمل دون راحة"]},
  {q:"التفكير النقدي يساعد على:", opts:["الحفظ السريع","تقليد الآخرين","تحليل المواقف واتخاذ القرار الصحيح","تجنّب العمل الجماعي"]},
  {q:"التواصل الفعّال يعتمد على:", opts:["كثرة الكلام","وضوح الفكرة ولغة الجسد","الصوت العالي","الجدال"]},
  {q:"من صفات القائد الحقيقي:", opts:["فرض السيطرة","تحفيز الفريق وتشجيعه","تجاهل آراء الآخرين","حب الظهور"]},
  {q:"عند مواجهة ضغط كبير في الحياة، الأفضل:", opts:["الاستسلام","الهروب من الموقف","تهدئة النفس وتجزئة المشكلة","لوم الآخرين"]},
  {q:"تحديد الأهداف يساعد على:", opts:["تقليل الحماس","ضياع الوقت","وضوح الطريق والتحفيز","زيادة التوتر"]},
  {q:"التعاون مع الفريق يعني:", opts:["المنافسة","المشاركة في الأفكار والجهد","الصمت","تجنب المسؤولية"]}
];

function renderMCQ(){
  const mcqList = document.getElementById('mcqList');
  mcqList.innerHTML = '';
  mcqQuestions.forEach((m, idx)=>{
    const wrapper = document.createElement('div');
    wrapper.className = 'mcq-question';
    const title = document.createElement('div');
    title.style.fontWeight='700';
    title.textContent = `${idx+1}. ${m.q}`;
    wrapper.appendChild(title);
    m.opts.forEach((opt,j)=>{
      const op = document.createElement('div');
      op.className = 'opt';
      op.textContent = `${String.fromCharCode(65+j)}) ${opt}`;
      op.addEventListener('click', ()=>{
        answers.mcq[idx+1] = j;
        // visual
        wrapper.querySelectorAll('.opt').forEach(n=>n.classList.remove('selected'));
        op.classList.add('selected');
        saveProgress();
      });
      wrapper.appendChild(op);
    });
    mcqList.appendChild(wrapper);
  });
}
renderMCQ();

/* عند الضغط التالي من MCQ */
document.getElementById('nextFromMCQ').addEventListener('click', ()=>{
  // save progress (already saved on click)
  saveProgress();
  showPage(10); // go to essays
});

/* ========== Essays: إنشاء الحقول الـ10 ========== */
const essayPrompts = [
  "ما هو هدفك الرئيسي في الحياة؟",
  "كيف تخطط لتحقيق أهدافك المستقبلية؟",
  "ما التحديات التي قد تواجهها أثناء تنفيذ خططك؟",
  "ما أهمية تحديد الأهداف قصيرة المدى؟",
  "كيف تساعدك مهارة إدارة الوقت في تحقيق أهدافك؟",
  "ما الأدوات أو الوسائل التي تستخدمها في التخطيط الشخصي؟",
  "من هو الشخص الذي يلهمك في السعي نحو النجاح؟",
  "كيف تتعامل مع الفشل أو الإخفاق في تحقيق هدف ما؟",
  "كيف تقيم تقدمك نحو تحقيق أهدافك؟",
  "ما النصيحة التي تقدمها لشخص يريد البدء في التخطيط لمستقبله؟"
];

function renderEssays(){
  const container = document.getElementById('essaysContainer');
  container.innerHTML = '';
  essayPrompts.forEach((p, idx)=>{
    const wrapper = document.createElement('div');
    wrapper.className = 'card';
    const label = document.createElement('label');
    label.className = 'small';
    label.textContent = `${idx+1}. ${p}`;
    const ta = document.createElement('textarea');
    ta.id = 'essay'+(idx+1);
    ta.placeholder = 'اكتب إجابتك هنا...';
    // restore if exists
    if(answers.essays[idx+1]) ta.value = answers.essays[idx+1];
    wrapper.appendChild(label);
    wrapper.appendChild(ta);
    container.appendChild(wrapper);
  });
}
renderEssays();

/* الانتقال من essays إلى النتيجة */
document.getElementById('toResult').addEventListener('click', ()=>{
  // save essay answers
  essayPrompts.forEach((_,i)=>{
    const id = 'essay'+(i+1);
    answers.essays[i+1] = document.getElementById(id).value.trim() || 'لم يُجب';
  });
  saveProgress();
  showPage(11);
});

/* ========== حساب النتيجة وإظهارها ========== */
function computeAndShowResult(){
  // حساب الأكواد الصحيحة
  let codeCorrect = 0; let totalCodes = 0;
  for(let p in secretCodes){
    totalCodes++;
    const entered = (answers.codes[p] || '').trim();
    if(entered === secretCodes[p]) codeCorrect++;
  }
  // حساب MCQ صحيحة بمقارنة مع mcqCorrect
  let mcqCorrectCount = 0;
  mcqQuestions.forEach((_, idx)=>{
    const user = answers.mcq[idx+1];
    if(typeof user !== 'undefined' && user === mcqCorrect[idx]) mcqCorrectCount++;
  });
  const totalMCQ = mcqQuestions.length;
  // وزن: الأكواد تشكل 60%، MCQ تشكل 40% (يمكن تعديل)
  const score = Math.round(((codeCorrect / totalCodes) * 0.6 + (mcqCorrectCount / totalMCQ) * 0.4) * 100);
  document.getElementById('scorePct').textContent = `${score}%`;
  saveProgress();
}

/* ========== إرسال الرسالة إلى WhatsApp ========== */
function buildWhatsAppMessage(){
  // time elapsed
  const rem = Number(localStorage.getItem('timerRemaining'));
  let elapsedStr = 'غير متاح';
  if(!isNaN(rem)) {
    const elapsed = Math.max(0, TOTAL_SECONDS - rem);
    const mm = Math.floor(elapsed/60), ss = elapsed%60;
    elapsedStr = `${mm} دقيقة و ${ss} ثانية`;
  }
  const lines = [];
  lines.push('📘 اسم الاختبار: الاختبار النهائي');
  lines.push('');
  lines.push(`👤 اسم الطالب: ${answers.meta.name || 'غير مُدرج'}`);
  lines.push(`🏙️ المحافظة: ${answers.meta.province || 'غير مُدرج'}`);
  lines.push(`📞 رقم الهاتف: ${answers.meta.phone || 'غير مُدرج'}`);
  lines.push(`📧 البريد الإلكتروني: ${answers.meta.email || 'غير مُدرج'}`);
  lines.push(`⏱️ الوقت المستغرق: ${elapsedStr}`);
  lines.push('─────────────────────');
  lines.push('✍️ الأسئلة المقالية:');
  for(let i=1;i<=essayPrompts.length;i++){
    lines.push(`${i}- ${answers.essays[i] || 'لم يُجب'}`);
  }
  lines.push('─────────────────────');
  lines.push('🧠 الأسئلة الاختيارية:');
  mcqQuestions.forEach((m, idx)=>{
    const userIdx = answers.mcq[idx+1];
    if(typeof userIdx === 'undefined') lines.push(`${idx+1}- لم يجاوب`);
    else lines.push(`${idx+1}- ${String.fromCharCode(65+userIdx)} — ${m.opts[userIdx]}`);
  });
  lines.push('─────────────────────');
  lines.push('🔢 أكواد الدخول (ما كتبه المستخدم):');
  for(let p=2;p<=8;p++){
    const qnum = p-1;
    lines.push(`${qnum}- ${answers.codes[p] || 'لم يُدخل'}`);
  }
  lines.push('─────────────────────');
  lines.push(`📊 النتيجة النهائية: ${document.getElementById('scorePct').textContent || '--%'}`);
  lines.push('─────────────────────');
  lines.push('📅 تم توليد هذه النتيجة تلقائياً بواسطة النظام.');
  return encodeURIComponent(lines.join('\n'));
}

document.getElementById('sendAnswersBtn').addEventListener('click', ()=>{
  // ensure essays saved
  for(let i=1;i<=essayPrompts.length;i++) answers.essays[i] = document.getElementById('essay'+i).value.trim() || 'لم يُجب';
  computeAndShowResult(); saveProgress();
  const msg = buildWhatsAppMessage();
  const phone = '201505997273';
  window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
});
document.getElementById('sendAnswersBtnExit').addEventListener('click', ()=>{
  for(let i=1;i<=essayPrompts.length;i++) answers.essays[i] = document.getElementById('essay'+i).value?.trim() || 'لم يُجب';
  computeAndShowResult(); saveProgress();
  const msg = buildWhatsAppMessage();
  const phone = '201505997273';
  window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
});

/* ========== صفحة الخروج: إظهار صندوق إعادة الفتح عند الضغط على "الخروج" ========== */
document.getElementById('openReopenBox')?.addEventListener('click', ()=>{
  // open modal (reopen)
  document.getElementById('reopenModal').style.display = 'flex';
});
document.getElementById('goToExit').addEventListener('click', ()=> showPage(12));
document.getElementById('openReopenBox').addEventListener('click', ()=> {
  document.getElementById('reopenModal').style.display = 'flex';
});

/* reopen modal handlers */
document.getElementById('reopenCancel').addEventListener('click', ()=> document.getElementById('reopenModal').style.display = 'none');
document.getElementById('reopenConfirm').addEventListener('click', ()=> {
  const v = document.getElementById('reopenInput').value.trim();
  if(v === REOPEN_EXIT || v === REOPEN_TIME){
    // reset progress
    localStorage.removeItem('attempted');
    localStorage.removeItem('maxVisited');
    localStorage.removeItem('progressData');
    localStorage.removeItem('timerRemaining');
    // reset in-memory
    for(let k in answers){ if(typeof answers[k] === 'object') { for(let kk in answers[k]) delete answers[k][kk]; } else answers[k] = ''; }
    timerRemaining = TOTAL_SECONDS;
    document.getElementById('reopenModal').style.display = 'none';
    alert('تم إعادة فتح الاختبار. سيعود إلى صفحة البداية.');
    showPage(1,false);
  } else {
    alert('كود غير صحيح.');
  }
});

/* time modal handlers */
document.getElementById('timeModalCancel').addEventListener('click', ()=> document.getElementById('timeClosedModal').style.display = 'none');
document.getElementById('timeModalConfirm').addEventListener('click', ()=> {
  const v = document.getElementById('timeReopenInput').value.trim();
  if(v === REOPEN_TIME || v === REOPEN_EXIT){
    localStorage.removeItem('attempted');
    localStorage.removeItem('maxVisited');
    localStorage.removeItem('progressData');
    localStorage.removeItem('timerRemaining');
    for(let k in answers){ if(typeof answers[k] === 'object') { for(let kk in answers[k]) delete answers[k][kk]; } else answers[k] = ''; }
    timerRemaining = TOTAL_SECONDS;
    document.getElementById('timeClosedModal').style.display = 'none';
    alert('تم إعادة فتح الاختبار بعد انتهاء الوقت.');
    showPage(1,false);
  } else alert('كود غير صحيح.');
});

/* ========== المؤقت (12 دقيقة) ========== */
function startTimer(){
  if(timerInterval) return;
  const saved = Number(localStorage.getItem('timerRemaining'));
  if(!isNaN(saved) && saved>0) timerRemaining = saved;
  timerInterval = setInterval(()=>{
    timerRemaining--;
    localStorage.setItem('timerRemaining', String(timerRemaining));
    updateTimerDisplay();
    if(timerRemaining <= 0){
      clearInterval(timerInterval); timerInterval=null;
      // عرض مودال غلق الوقت لكن فقط إذا المستخدم داخل الاختبار (لم ينتهِ)
      // شرط: إذا لم يصل المستخدم لصفحة النتيجة أو للخروج
      if(currentPage !== 11 && currentPage !== 12){
        document.getElementById('timeClosedModal').style.display = 'flex';
        showPage(12,false); // اذهب للصفحة 12 (الخروج)
      }
    }
  },1000);
  updateTimerDisplay();
}
function updateTimerDisplay(){
  const mm = Math.floor(Math.max(0,timerRemaining)/60).toString().padStart(2,'0');
  const ss = (timerRemaining%60).toString().padStart(2,'0');
  timerDisplay.textContent = `الوقت: ${mm}:${ss}`;
}

/* عند تحميل الصفحة، إذا سبق وبدأ المستخدم نعيد الحالة */
window.addEventListener('load', ()=>{
  const attempted = isAttempted();
  const maxVisited = Number(localStorage.getItem('maxVisited')||1);
  if(attempted && maxVisited>1){
    showPage(maxVisited,false);
    const savedTimer = Number(localStorage.getItem('timerRemaining'));
    if(!isNaN(savedTimer) && savedTimer>0){
      timerRemaining = savedTimer;
      startTimer();
    }
  }
});

/* حفظ دوري */
setInterval(()=> saveProgress(), 4000);

/* ========== منع الرجوع عبر زر المتصفح ========== */
history.pushState(null, document.title, location.href);
window.addEventListener('popstate', function (event) {
  history.pushState(null, document.title, location.href);
  alert('غير مسموح بالرجوع للصفحات السابقة.');
});

/* ========== تهيئة بعض الأشياء النهائية ========== */
// render essays & mcq initial state already called
renderEssays();

// disable prev initially
prevBtn.disabled = true;
showPage(1,false);

/* ========== small UX: when user navigates by nextBtn we mark show notify = true ========== */
nextBtn.addEventListener('click', ()=> {
  const target = currentPage + 1;
  if(target <= PAGES) showPage(target,true);
});
prevBtn.addEventListener('click', ()=> { const target = currentPage - 1; if(target>=1) showPage(target,true); });

</script>
</body>
</html>